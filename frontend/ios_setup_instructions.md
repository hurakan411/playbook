# iOS アプリ内課金の設定手順

このアプリには iOS の月額サブスクリプション機能が実装されています。アプリストアで実際に課金を有効にするには、以下の設定が必要です。

## 1. App Store Connect でのプロダクト設定

### App Store Connect にアクセス
1. [App Store Connect](https://appstoreconnect.apple.com) にログイン
2. 対象のアプリを選択
3. 「機能」タブ → 「App内課金」を選択

### サブスクリプション プロダクトの作成

#### ベーシックプラン
- **プロダクトID**: `basic_plan_monthly`
- **参照名**: ベーシックプラン（月額）
- **サブスクリプション期間**: 1ヶ月
- **価格**: 適切な価格を設定（例：¥480）
- **説明**: 絵本作成：月3回まで、ページ数：最大4ページ、画風：基本2画風、保存：無制限

#### プレミアムプラン
- **プロダクトID**: `premium_plan_monthly`
- **参照名**: プレミアムプラン（月額）
- **サブスクリプション期間**: 1ヶ月
- **価格**: 適切な価格を設定（例：¥980）
- **説明**: 絵本作成：月10回まで、ページ数：最大8ページ、画風：基本2画風＋追加4画風、保存：無制限

## 2. iOS アプリの設定

### Capabilities の追加
1. Xcode でプロジェクトを開く
2. プロジェクト設定 → 「Signing & Capabilities」
3. 「+ Capability」をクリック
4. 「In-App Purchase」を追加

### StoreKit Configuration（テスト用）
1. Xcode で「File」→「New」→「File」
2. 「StoreKit Configuration File」を選択
3. 上記のプロダクトIDで２つのサブスクリプションを追加
4. テスト時はこのファイルを使用

## 3. テスト方法

### Sandbox テスト
1. iOS Settings → App Store → Sandbox Account でテスト用 Apple ID を設定
2. アプリでサブスクリプション購入をテスト
3. 購入成功/失敗/復元の各ケースを確認

### App Store Connect でのテスト
1. App Store Connect → 「TestFlight」
2. Internal Testing でテスターを追加
3. テスターがサブスクリプション機能をテスト

## 4. プロダクション展開

### レビュー提出前の確認事項
- [ ] サブスクリプション機能が正常に動作する
- [ ] 利用規約とプライバシーポリシーが適切に設定されている
- [ ] 購入復元機能が正常に動作する
- [ ] サブスクリプション管理画面への適切なリンクが設定されている

### App Store Review
1. アプリをApp Store Connect にアップロード
2. App Store Review に提出
3. サブスクリプション機能が承認されると本番環境で利用可能

## 5. 実装済み機能

このアプリには以下の機能が実装済みです：

- ✅ サブスクリプション購入
- ✅ 購入復元
- ✅ プロダクト情報の取得
- ✅ 購入状態の管理
- ✅ エラーハンドリング
- ✅ ローディング表示
- ✅ ユーザーフレンドリーなUI

## 6. 注意事項

- プロダクトIDは `purchase_service.dart` で定義されているものと完全に一致させる必要があります
- サブスクリプションの価格や期間を変更する場合は、App Store Connect とアプリの両方で更新が必要です
- テスト環境と本番環境でプロダクトIDは同じものを使用します

## 7. トラブルシューティング

### よくある問題
- **プロダクトが見つからない**: プロダクトIDが一致していない、またはApp Store Connect での設定が未完了
- **購入が完了しない**: Sandbox アカウントの設定、ネットワーク接続の確認
- **復元が動作しない**: 同じApple IDでの購入履歴があるか確認

### デバッグ方法
- Xcode のコンソールで購入関連のログを確認
- `PurchaseService` クラスのエラーメッセージを確認
- StoreKit Diagnostics を使用してプロダクト状態を確認
